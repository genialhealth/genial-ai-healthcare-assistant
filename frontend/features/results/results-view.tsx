/**
 * ResultsView Component
 * 
 * Displays the list of potential medical conditions (differential diagnosis)
 * identified by the AI system based on the current conversation and image analysis.
 */

'use client';

import { useEffect } from 'react';
import { Header } from '@/components/header';
import { Card } from '@/components/card';
import { Button } from '@/components/button';
import { useGenialStore } from '@/lib/store';
import { 
  AlertCircle, 
  TrendingUp, 
  Info,
  ArrowRight,
  ShieldCheck,
  ShieldAlert,
  ShieldEllipsis
} from 'lucide-react';
import { MarkdownRenderer } from '@/components/markdown-renderer';

interface ResultsViewProps {
  /** Optional React nodes to render on the right side of the header */
  headerRightElements?: React.ReactNode;
}

export function ResultsView({ headerRightElements }: ResultsViewProps) {
  const { diseases, markDiagnosisRead, selectDisease } = useGenialStore();

  // Reset the "new diagnosis" notification state when this view is mounted
  useEffect(() => {
    markDiagnosisRead();
  }, [markDiagnosisRead]);

  /**
   * Maps a numerical likelihood score to UI styling and labels.
   * 
   * @param likelihood - A percentage score (0-100).
   * @returns Metadata for UI rendering including label, colors, and icon.
   */
  const getLikelihoodInfo = (likelihood: number) => {
    if (likelihood >= 70) {
      return {
        label: 'High Match',
        color: 'text-red-600',
        bg: 'bg-red-50',
        border: 'border-red-200',
        icon: ShieldAlert
      };
    }
    if (likelihood >= 40) {
      return {
        label: 'Medium Match',
        color: 'text-amber-600',
        bg: 'bg-amber-50',
        border: 'border-amber-200',
        icon: ShieldEllipsis
      };
    }
    return {
      label: 'Low Match',
      color: 'text-blue-600',
      bg: 'bg-blue-50',
      border: 'border-blue-200',
      icon: ShieldCheck
    };
  };

  return (
    <div className="flex flex-col h-full bg-background-primary">
      <Header title="Diseases" rightElements={headerRightElements} />

      <div className="flex-1 overflow-y-auto px-4 py-6 pb-24 no-scrollbar">
        {diseases.length === 0 ? (
          <div className="flex items-center justify-center min-h-[60vh] text-center px-6">
            <Card className="max-w-xs">
              <TrendingUp className="w-12 h-12 text-text-tertiary mx-auto mb-4" />
              <h3 className="text-lg font-bold text-navy-900 mb-2">No Match Yet</h3>
              <p className="text-text-secondary text-sm leading-relaxed">
                Continue your conversation in the Chat. As you describe symptoms, I will identify possible matches here.
              </p>
            </Card>
          </div>
        ) : (
          <div className="space-y-6">
            <div>
              <h2 className="text-2xl font-bold text-navy-900 mb-2">
                Possible Conditions
              </h2>
              <div className="flex items-start gap-2 text-text-secondary text-sm bg-navy-50/50 p-3 rounded-lg border border-navy-100">
                <Info className="w-4 h-4 mt-0.5 flex-shrink-0 text-navy-900" />
                <p>These findings are generated by AI for informational purposes and do not constitute a medical diagnosis.</p>
              </div>
            </div>

            <div className="space-y-4">
              {diseases.map((disease) => {
                const info = getLikelihoodInfo(disease.likelihood);
                const Icon = info.icon;

                return (
                  <Card key={disease.id} className={`p-0 overflow-hidden border-2 ${info.border} shadow-sm hover:shadow-md transition-all`}>
                    <div className={`${info.bg} px-4 py-2 border-b ${info.border} flex items-center justify-between`}>
                      <div className="flex items-center gap-2">
                        <Icon className={`w-4 h-4 ${info.color}`} />
                        <span className={`text-xs font-bold uppercase tracking-wider ${info.color}`}>
                          {info.label}
                        </span>
                      </div>
                    </div>
                    
                    <div className="p-4">
                      <h3 className="font-bold text-navy-900 text-xl mb-3">
                        {disease.name}
                      </h3>
                      
                      <div className="bg-background-secondary rounded-lg p-3 mb-4">
                        <h4 className="text-[10px] font-bold text-text-tertiary uppercase tracking-tight mb-1">Reasoning</h4>
                        <MarkdownRenderer 
                          content={disease.reason}
                          className="text-[14px] text-text-primary leading-relaxed"
                        />
                      </div>

                      <Button
                        variant="secondary"
                        onClick={() => selectDisease(disease)}
                        className="w-full flex items-center justify-center gap-2 font-bold group"
                      >
                        Deep Look & Analysis
                        <ArrowRight className="w-4 h-4 group-hover:translate-x-1 transition-transform" />
                      </Button>
                    </div>
                  </Card>
                );
              })}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
